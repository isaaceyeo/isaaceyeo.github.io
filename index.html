<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Franchise Compliance Results</title>

    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        :root {
            --red: #CC4B4B;
            --offwhite: #F3F8EE;
            --teal: #B9DCD5;
            --steel: #5A85A0;
            --navy: #1E324F;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", Arial, sans-serif;
            background: var(--offwhite);
            margin: 0;
            padding: 30px 10px;
            display: flex;
            justify-content: center;
        }

        .page {
            max-width: 1100px;
            width: 100%;
        }

        .header-card {
            background: white;
            border-radius: 16px;
            padding: 24px 28px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.10);
            border-top: 10px solid var(--navy);
            margin-bottom: 20px;
        }

        .header-title {
            font-size: 26px;
            color: var(--navy);
            margin: 0 0 6px 0;
            letter-spacing: -0.4px;
        }

        .header-sub {
            margin: 0;
            color: var(--steel);
            font-size: 15px;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
            grid-gap: 18px;
            margin-bottom: 18px;
        }

        @media (max-width: 900px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 14px;
            padding: 20px 22px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        .card h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: var(--navy);
        }

        .card p {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: var(--steel);
        }

        .upload-group {
            margin-top: 8px;
        }

        #fileInput {
            margin-top: 8px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--teal);
            background: #ffffff;
            width: 100%;
        }

        #analyzeBtn {
            margin-top: 12px;
            padding: 11px 18px;
            font-size: 15px;
            background: var(--navy);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        #analyzeBtn:hover {
            background: var(--steel);
        }

        #loading {
            display: none;
            margin-top: 10px;
            font-size: 13px;
            color: var(--steel);
        }

        .hint {
            font-size: 12px;
            color: var(--steel);
            margin-top: 6px;
        }

        .summary-metric {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .summary-score {
            font-size: 28px;
            color: var(--navy);
            font-weight: 600;
        }

        .summary-label {
            font-size: 13px;
            color: var(--steel);
        }

        .risk-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
        }

        .risk-low {
            background: var(--teal);
            color: var(--navy);
        }

        .risk-med {
            background: #FFE6B3;
            color: #7A5A1F;
        }

        .risk-high {
            background: #FCE0E0;
            color: var(--red);
        }

        .progress-bar-outer {
            width: 100%;
            height: 10px;
            background: #E3EBE2;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 8px;
            margin-bottom: 6px;
        }

        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background: var(--teal);
            transition: width 0.4s ease;
        }

        .summary-note {
            font-size: 12px;
            color: var(--steel);
            margin-top: 6px;
        }

        .alert {
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 13px;
            margin-top: 8px;
        }

        .alert-info {
            background: #E3EFF5;
            color: #294764;
        }

        .alert-warn {
            background: #FFF1E3;
            color: #7A4A14;
        }

        .alert-danger {
            background: #FDE6E6;
            color: var(--red);
        }

        .checklist-section {
            margin-top: 16px;
        }

        .checklist-title {
            font-size: 18px;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .checklist-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .item-card {
            border-radius: 12px;
            padding: 14px 14px 12px 14px;
            border: 1px solid #E3EBE2;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            align-items: baseline;
        }

        .item-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--navy);
        }

        .item-tag {
            font-size: 11px;
            padding: 3px 7px;
            border-radius: 999px;
            background: #E6F1ED;
            color: #305C48;
            white-space: nowrap;
        }

        .item-status {
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-found {
            color: #1F7A4D;
        }

        .status-missing {
            color: var(--red);
        }

        .status-stat {
            color: #7A5A1F;
        }

        .item-desc {
            font-size: 12px;
            color: var(--steel);
        }

        .item-icon {
            font-size: 14px;
        }

        .sign-card {
            margin-top: 16px;
        }

        #signBtn {
            margin-top: 10px;
            padding: 12px 20px;
            font-size: 15px;
            border-radius: 999px;
            border: none;
            cursor: not-allowed;
            background: #C7D2CF;
            color: #6B7B77;
        }

        #signBtn.enabled {
            cursor: pointer;
            background: var(--navy);
            color: white;
        }

        #signLockMsg {
            font-size: 12px;
            color: var(--red);
            margin-top: 6px;
        }
    </style>
</head>
<body>
<div class="page">

    <div class="header-card">
        <h1 class="header-title">Franchise Compliance Analysis</h1>
        <p class="header-sub">
            This dashboard analyzes your franchise disclosure or agreement against core 
            requirements from <strong>Ontario franchise law.</strong>
        </p>
    </div>

    <div class="layout">
        <!-- LEFT: Upload + Checklist -->
        <div class="card">
            <h2>1. Upload & Analyze</h2>
            <p>
                For security reasons, you must upload your document on this page. 
                We scan the text and flag potential disclosure gaps.
            </p>

            <div class="upload-group">
                <input type="file" id="fileInput" accept=".pdf,.txt" />
                <button id="analyzeBtn">Run Compliance Check</button>
                <div id="loading">Reading document and scanning for legal terms…</div>
                <div class="hint">
                    Supported formats: PDF (.pdf) or plain text (.txt).
                </div>
            </div>

            <div class="checklist-section">
                <div class="checklist-title">Checklist Items</div>
                <p class="hint">
                    We look for the following key components from your Topic 7 slides:
                </p>
                <ul class="hint">
                    <li>Consideration (fees & royalties)</li>
                    <li>Conduct of the business</li>
                    <li>Termination terms</li>
                    <li>Restrictive covenants</li>
                    <li>Intellectual property rights</li>
                    <li>Right to disclosure (material facts)</li>
                    <li>Duty of fair dealing</li>
                    <li>Right to associate</li>
                </ul>
            </div>
        </div>

        <!-- RIGHT: Summary -->
        <div class="card">
            <h2>2. Compliance Summary</h2>

            <div class="summary-metric">
                <div>
                    <div class="summary-score" id="scoreDisplay">0 / 8</div>
                    <div class="summary-label">Checklist Items Satisfied</div>
                </div>
                <div id="riskBadge" class="risk-badge risk-high">
                    High Risk
                </div>
            </div>

            <div class="progress-bar-outer">
                <div id="progressInner" class="progress-bar-inner"></div>
            </div>

            <div class="summary-note" id="riskDetail">
                Run an analysis to see your compliance score and risk level.
            </div>

            <div id="statAlert" class="alert alert-info" style="margin-top:14px;">
                Statutory rights (disclosure, fair dealing, right to associate) apply even if 
                they are not written in the contract. If they are not mentioned, franchisees 
                may still expect them — increasing legal risk.
            </div>
        </div>
    </div>

    <!-- FULL-WIDTH CHECKLIST GRID -->
    <div class="card">
        <h2>3. Detailed Checklist</h2>
        <p>
            Each item below is scanned for keywords in your document. This tool does not give legal advice, 
            but helps flag potential gaps for review.
        </p>

        <div class="checklist-grid" id="checklistGrid">
            <!-- Cards will be injected by JavaScript -->
        </div>
    </div>

    <!-- SIGNING LOCK SECTION -->
    <div class="card sign-card">
        <h2>4. Signing Lock</h2>
        <p>
            To reduce legal risk, this MVP blocks “proceed to signing” if any checklist items are missing. 
            In a real system, this could be integrated before electronic signatures are enabled.
        </p>

        <button id="signBtn" disabled>Proceed to Signing</button>
        <div id="signLockMsg">
            Disclosure incomplete. Do <strong>NOT</strong> sign until all red items are resolved.
        </div>
    </div>

</div>

<script>
    // Configure PDF.js worker
    if (window['pdfjsLib']) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    }

    const fileInput = document.getElementById("fileInput");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const loadingEl = document.getElementById("loading");
    const checklistGrid = document.getElementById("checklistGrid");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const riskBadge = document.getElementById("riskBadge");
    const riskDetail = document.getElementById("riskDetail");
    const progressInner = document.getElementById("progressInner");
    const signBtn = document.getElementById("signBtn");
    const signLockMsg = document.getElementById("signLockMsg");
    const statAlert = document.getElementById("statAlert");

    // Our 8 checklist items
    const checklistItems = [
        {
            id: "consideration",
            title: "Consideration of the Parties (Fees & Royalties)",
            tag: "Agreement Term",
            severity: "required",
            keywords: ["fee", "fees", "royalty", "royalties", "initial fee", "franchise fee", "payment"]
        },
        {
            id: "conduct",
            title: "Conduct of the Business (Operating Restrictions)",
            tag: "Agreement Term",
            severity: "required",
            keywords: ["conduct of the business", "operations", "operate", "store must", "location", "products", "menu"]
        },
        {
            id: "termination",
            title: "Termination of the Agreement",
            tag: "Agreement Term",
            severity: "required",
            keywords: ["termination", "terminate", "end of this agreement", "expiry", "cancel this agreement"]
        },
        {
            id: "restrictive",
            title: "Restrictive Covenants (Non-Competition etc.)",
            tag: "Agreement Term",
            severity: "required",
            keywords: ["restrictive covenant", "non-competition", "non competition", "non-compete", "not compete", "restriction on competing"]
        },
        {
            id: "ip",
            title: "Intellectual Property Rights (Trademarks & Processes)",
            tag: "Agreement Term",
            severity: "required",
            keywords: ["intellectual property", "trademark", "trademarks", "logo", "brand", "business processes", "proprietary system"]
        },
        {
            id: "disclosure",
            title: "Right to Disclosure (Material Facts)",
            tag: "Statutory Right",
            severity: "statutory",
            keywords: ["material fact", "material facts", "full disclosure", "disclosure document", "arthur wishart"]
        },
        {
            id: "goodfaith",
            title: "Duty of Fair Dealing / Good Faith",
            tag: "Statutory Right",
            severity: "statutory",
            keywords: ["good faith", "fair dealing", "act honestly", "duty of good faith"]
        },
        {
            id: "associate",
            title: "Right to Associate with Other Franchisees",
            tag: "Statutory Right",
            severity: "statutory",
            keywords: ["right to associate", "association of franchisees", "franchisee association", "associate with other franchisees"]
        }
    ];

    // Render checklist UI
    function renderChecklist(resultsMap) {
        checklistGrid.innerHTML = "";

        checklistItems.forEach(item => {
            const found = resultsMap ? resultsMap[item.id] : null;

            const card = document.createElement("div");
            card.className = "item-card";

            const header = document.createElement("div");
            header.className = "item-header";

            const titleEl = document.createElement("div");
            titleEl.className = "item-title";
            titleEl.textContent = item.title;

            const tagEl = document.createElement("div");
            tagEl.className = "item-tag";
            tagEl.textContent = item.tag;

            header.appendChild(titleEl);
            header.appendChild(tagEl);

            const statusEl = document.createElement("div");
            statusEl.className = "item-status";

            const iconSpan = document.createElement("span");
            iconSpan.className = "item-icon";

            const textSpan = document.createElement("span");

            const descEl = document.createElement("div");
            descEl.className = "item-desc";

            if (found === true) {
                statusEl.classList.add("status-found");
                iconSpan.textContent = "✔";
                textSpan.textContent = "Found in document";
                if (item.severity === "statutory") {
                    descEl.textContent = "This statutory right is referenced in your document.";
                } else {
                    descEl.textContent = "Core business term appears to be addressed.";
                }
            } else if (found === false) {
                if (item.severity === "required") {
                    statusEl.classList.add("status-missing");
                    iconSpan.textContent = "✖";
                    textSpan.textContent = "Missing or unclear";
                    descEl.textContent = "This core agreement term was not detected. Consider reviewing the draft carefully.";
                } else {
                    statusEl.classList.add("status-stat");
                    iconSpan.textContent = "⚠";
                    textSpan.textContent = "Not mentioned, but still applies by law";
                    descEl.textContent = "This right exists under the Arthur Wishart Act even if not written. Consider explicitly acknowledging it to avoid misunderstandings.";
                }
            } else {
                statusEl.classList.add("status-stat");
                iconSpan.textContent = "…";
                textSpan.textContent = "Awaiting analysis";
                descEl.textContent = "Run the compliance check to classify this item.";
            }

            statusEl.appendChild(iconSpan);
            statusEl.appendChild(textSpan);

            card.appendChild(header);
            card.appendChild(statusEl);
            card.appendChild(descEl);

            checklistGrid.appendChild(card);
        });
    }

    // Initial render (no results yet)
    renderChecklist(null);

    // Extract text from PDF using PDF.js
    async function extractTextFromPDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = "";

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const content = await page.getTextContent();
            const pageText = content.items.map(i => i.str).join(" ");
            fullText += " " + pageText;
        }
        return fullText.toLowerCase();
    }

    // Extract from text file
    function extractTextFromTxt(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => {
                resolve(String(e.target.result).toLowerCase());
            };
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }

    // Run analysis
    async function runAnalysis() {
        const file = fileInput.files[0];
        if (!file) {
            alert("Please upload a PDF or text file first.");
            return;
        }

        loadingEl.style.display = "block";
        analyzeBtn.disabled = true;
        signBtn.disabled = true;
        signBtn.classList.remove("enabled");

        let text = "";

        try {
            if (file.name.toLowerCase().endsWith(".pdf") || file.type === "application/pdf") {
                text = await extractTextFromPDF(file);
            } else {
                text = await extractTextFromTxt(file);
            }
        } catch (err) {
            console.error(err);
            alert("There was a problem reading this file. Try a simpler PDF or a .txt version.");
            loadingEl.style.display = "none";
            analyzeBtn.disabled = false;
            return;
        }

        const resultsMap = {};
        checklistItems.forEach(item => {
            let found = false;
            for (const kw of item.keywords) {
                if (text.includes(kw.toLowerCase())) {
                    found = true;
                    break;
                }
            }
            resultsMap[item.id] = found;
        });

        // Update checklist UI
        renderChecklist(resultsMap);

        // Calculate score (items that are found)
        let score = 0;
        checklistItems.forEach(item => {
            if (resultsMap[item.id] === true) score++;
        });

        scoreDisplay.textContent = score + " / " + checklistItems.length;
        const percent = (score / checklistItems.length) * 100;
        progressInner.style.width = percent + "%";

        // Determine risk level
        let riskClass = "risk-high";
        let riskText = "High Risk";
        let detailText = "Several key terms or rights were not detected. The agreement should be reviewed before signing.";

        if (score >= 7) {
            riskClass = "risk-low";
            riskText = "Low Risk";
            detailText = "Most key items were detected. Legal review is still recommended, but risk appears lower.";
        } else if (score >= 5) {
            riskClass = "risk-med";
            riskText = "Medium Risk";
            detailText = "Some important items could be missing or unclear. Further legal review is advisable.";
        }

        riskBadge.className = "risk-badge " + riskClass;
        riskBadge.textContent = riskText;
        riskDetail.textContent = detailText;

        // Signing Lock: require ALL items to be found to enable
        const allFound = checklistItems.every(item => resultsMap[item.id] === true);

        if (allFound) {
            signBtn.disabled = false;
            signBtn.classList.add("enabled");
            signLockMsg.style.color = "#1F7A4D";
            signLockMsg.innerHTML = "All checklist items were detected. You may proceed, but <strong>legal advice is still recommended</strong>.";
        } else {
            signBtn.disabled = true;
            signBtn.classList.remove("enabled");
            signLockMsg.style.color = "var(--red)";
            signLockMsg.innerHTML = "Disclosure incomplete. Do <strong>NOT</strong> sign until all red and warning items are reviewed.";
        }

        loadingEl.style.display = "none";
        analyzeBtn.disabled = false;

        // If any statutory items are missing, emphasize alert
        const statutoryMissing = checklistItems.some(
            item => item.severity === "statutory" && resultsMap[item.id] === false
        );

        if (statutoryMissing) {
            statAlert.className = "alert alert-warn";
            statAlert.textContent =
                "One or more statutory rights (disclosure, fair dealing, right to associate) were not mentioned. " +
                "They still apply under the Arthur Wishart Act, but omission may create additional legal risk.";
        } else {
            statAlert.className = "alert alert-info";
            statAlert.textContent =
                "Statutory rights (disclosure, fair dealing, right to associate) appear in your document or were detected. " +
                "They still apply by law and should be honoured in practice.";
        }
    }

    analyzeBtn.addEventListener("click", runAnalysis);

    // Dummy click handler for sign button (for demo purposes only)
    signBtn.addEventListener("click", function () {
        if (signBtn.disabled) return;
        alert("In a full system, this would trigger an e-signature process. For this MVP, it simply demonstrates the lock.");
    });
</script>
</body>
</html>
